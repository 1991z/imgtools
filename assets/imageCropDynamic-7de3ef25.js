import{_ as e,o as t,c as a,b as s,d as l,e as n,v as o,r as i,a as d,w as c,h,f as u,g as r,F as f}from"./index-5fa3503f.js";import{i as m,S as v,a as g,b,s as p}from"./ShowDataObj-75f42c8b.js";import{S as y,D as w}from"./DownloadImage-ab76d0e4.js";const x={class:"max-box"},_=["src"],I={class:"min-box"},D={class:"min-box"},C={class:"min-box"};const X=e({props:{initData:{type:Object}},data:()=>({base64:"",sel:1,offsetX:0,offsetY:0,locs:[],width:0,height:0}),mounted(){Object.assign(this.$data,this.$props.initData)},methods:{readFIle(e){let t=e.target.files;for(let a=0;a<t.length;a++){let e=new FileReader;e.readAsDataURL(t[a]),e.onload=e=>{this.$data.base64=e.target.result}}},loadImg(e){let t=e.target.naturalWidth,a=e.target.naturalHeight;this.$data.width=t,this.$data.height=a;let{base64:s,sel:l,offsetX:n,offsetY:o,locs:i}=this.$data;this.$emit("c-data",{base64:s,sel:l,offsetX:n,offsetY:o,locs:i,width:t,height:a})}},watch:{sel:{handler(){this.$emit("c-data",{sel:this.sel})}},offsetX:{handler(){this.$emit("c-data",{offsetX:this.offsetX})}},offsetY:{handler(){this.$emit("c-data",{offsetY:this.offsetY})}},initData:{handler(e){Object.assign(this.$data,e)}}}},[["render",function(e,i,d,c,h,u){return t(),a("div",x,[s("img",{src:h.base64,alt:"参考图片",onLoad:i[0]||(i[0]=(...e)=>u.loadImg&&u.loadImg(...e))},null,40,_),s("div",I,[s("input",{type:"file",accept:"image/jpeg,image/jpg,image/png",onChange:i[1]||(i[1]=(...e)=>u.readFIle&&u.readFIle(...e))},null,32),s("button",{onClick:i[2]||(i[2]=t=>e.$emit("c-test"))},"测试")]),s("div",D,[i[6]||(i[6]=l(" 第N个")),n(s("input",{type:"number","onUpdate:modelValue":i[3]||(i[3]=e=>h.sel=e)},null,512),[[o,h.sel]])]),s("div",C,[n(s("input",{type:"number","onUpdate:modelValue":i[4]||(i[4]=e=>h.offsetX=e),placeholder:"dx"},null,512),[[o,h.offsetX]]),n(s("input",{type:"number","onUpdate:modelValue":i[5]||(i[5]=e=>h.offsetY=e),placeholder:"dy"},null,512),[[o,h.offsetY]])])])}],["__scopeId","data-v-9c419087"]]),Y=e=>{let t={},a=97;for(let l=0;l<e.length;l++){let s=!0;for(let a in t)if(t[a].some((t=>{return a=e[l],s=t,Math.abs(a.x-s.x)<2&&Math.abs(a.y-s.y)<2;var a,s}))){t[a].push(e[l]),s=!1;break}s&&(t[String.fromCharCode(a)]=[e[l]],a++)}let s=[];for(let l in t){let e=0,a=0;for(let s=0;s<t[l].length;s++)e+=t[l][s].x,a+=t[l][s].y;e=Math.floor(e/t[l].length),a=Math.floor(a/t[l].length),s.push({x:e,y:a})}return s},M=(e,t)=>{const a=[],s=e.data32F;for(let h=0;h<s.length;h++)if(s[h]>.8){const t=Math.floor(h/e.cols),s=h%e.cols;a.push({x:s,y:t})}let l=Y(a),{sel:n,offsetX:o,offsetY:i}=t;n<0?(l=l.slice().reverse(),n=-n):0==n&&(n=1),n>l.length&&(n=l.length);let{x:d,y:c}=l[n-1];return{x:d+o,y:c+i}},j={key:0},E={key:0},O={key:1,class:"doBox"},F=["src"],$="cropdynamic",k=e({__name:"imageCropDynamic",setup(e){const l=i(m($,[])),o=i([]);function x(e){o.value.push(e)}function _(e){for(let t=0;t<o.value.length;t++)if(o.value[t].timeStamp==e.k){o.value[t].width=e.w,o.value[t].height=e.h;break}}function I(e){let t=e.target.naturalWidth,a=e.target.naturalHeight;const s=document.getElementById("imgbg"),l=document.getElementById("canvas1"),n=document.getElementById("canvas2");l.style.width=s.width+"px",l.style.height=s.height+"px",n.style.width=s.width+"px",n.style.height=s.height+"px",l.width=t,l.height=a,n.width=t,n.height=a}function D(e){let t,a,s;if(e){if(0==B.value.locs.length)return;a=document.getElementById("canvas2"),t=B.value,s="rgba(0, 255, 0, 1)"}else{if(0==k.value.locs.length)return;a=document.getElementById("canvas1"),t=k.value,s="rgba(255, 0, 0, 1)"}let l=(e=>{let{sel:t,offsetX:a,offsetY:s,locs:l}=e;t<0?(l=l.slice().reverse(),t=-t):0==t&&(t=1),t>l.length&&(t=l.length);let{x:n,y:o}=l[t-1];return{x:n+a,y:o+s}})(t);const n=a.getContext("2d");n.clearRect(0,0,a.width,a.height),n.beginPath(),n.strokeStyle=s,t.locs.forEach((e=>{n.rect(e.x,e.y,t.width,t.height)})),n.moveTo(l.x,0),n.lineTo(l.x,a.height),n.moveTo(0,l.y),n.lineTo(a.width,l.y),n.stroke()}function C(e){let t=e?B.value:k.value;var a,s;(a=o.value[0],s=t,new Promise(((e,t)=>{const l=new Image;l.onload=()=>{const a=new Image;a.onload=()=>{const s=cv.imread(l),n=cv.imread(a),o=new cv.Mat;try{cv.matchTemplate(s,n,o,cv.TM_CCOEFF_NORMED)}catch(c){return void t("no match")}const i=[],d=o.data32F;for(let e=0;e<d.length;e++)if(d[e]>.8){const t=Math.floor(e/o.cols),a=e%o.cols;i.push({x:a,y:t})}s.delete(),n.delete(),e(Y(i))},a.src=s.base64},l.src=a.base64}))).then((t=>(t=>{e?B.value.locs=t:k.value.locs=t,D(e)})(t))).catch((e=>{}))}const k=i({locs:[]});function T(e){k.value=Object.assign(k.value,e),D(0)}const B=i({locs:[]});function R(e){B.value=Object.assign(B.value,e),D(1)}const S=i([]);function U(){o.value.forEach(((e,t)=>{((e,t,a,s,l)=>new Promise(((n,o)=>{if(void 0===e.base64)return void o("image no base64");if(void 0===t.base64)return void o("match1 no base64");if(void 0===a.base64)return void o("match2 no base64");if(s<0||s>.97)return void o("quality must be between 0 and 0.97");const i=new Image;i.onload=()=>{const e=new Image;e.onload=()=>{const d=new Image;d.onload=()=>{const c=cv.imread(i),h=cv.imread(e),u=cv.imread(d),r=new cv.Mat,f=new cv.Mat;try{cv.matchTemplate(c,h,r,cv.TM_CCOEFF_NORMED),cv.matchTemplate(c,u,f,cv.TM_CCOEFF_NORMED)}catch(C){return void o("no match")}const m=M(r,t),v=M(f,a);let g,b,p,y;if(c.delete(),h.delete(),u.delete(),m.x<v.x?(g=m.x,p=v.x-m.x):(g=v.x,p=m.x-v.x),m.y<v.y?(b=m.y,y=v.y-m.y):(b=v.y,y=m.y-v.y),p<10||y<10)return void o("width or height too small");g<0&&(g=0),b<0&&(b=0),p>i.width&&(p=i.width),y>i.height&&(y=i.height),g+p>i.width&&(g=i.width-p),b+y>i.height&&(b=i.height-y);const w=document.createElement("canvas");w.width=p,w.height=y,w.getContext("2d").drawImage(i,g,b,p,y,0,0,p,y);const x="image/jpeg",_=w.toDataURL(x,s);let I=_.length-`data:${x};base64,`.length;I=parseInt(I-I/4);const D=Date.parse(new Date)/100+l;n({size:I,type:x,timeStamp:D,base64:_})},d.src=a.base64},e.src=t.base64},i.src=e.base64})))(e,k.value,B.value,.3,t).then((e=>{S.value.push(e)})).catch((e=>{}))}))}const H=i(!0),L=i(null),N=i(null);function P(){let e={name:"",md1_base64:k.value.base64||"",md1_sel:k.value.sel||1,md1_offsetX:k.value.offsetX||0,md1_offsetY:k.value.offsetY||0,md2_base64:B.value.base64||"",md2_sel:B.value.sel||1,md2_offsetX:B.value.offsetX||0,md2_offsetY:B.value.offsetY||0};b(e,l.value)||(l.value.push(e),p($,l.value))}function V(e){L.value={base64:e.md1_base64,sel:e.md1_sel,offsetX:e.md1_offsetX,offsetY:e.md1_offsetY},N.value={base64:e.md2_base64,sel:e.md2_sel,offsetX:e.md2_offsetX,offsetY:e.md2_offsetY}}function W(e){p($,e)}return(e,i)=>(t(),a(f,null,[d(v,{multiple:"",onGetImage:x},{default:c((()=>[o.value.length>0?(t(),a("div",j,[s("button",{onClick:i[0]||(i[0]=e=>H.value=!H.value)},"设置参考"),s("button",{onClick:U,style:{"margin-left":"2px"}},"裁剪")])):u("",!0)])),_:1}),d(y,{images:o.value,name:"imagesBox1",onGetWH:_},null,8,["images"]),o.value.length>0?n((t(),a("div",E,[d(X,{initData:L.value,onCTest:i[1]||(i[1]=e=>C(0)),onCData:T},null,8,["initData"]),d(X,{initData:N.value,onCTest:i[2]||(i[2]=e=>C(1)),onCData:R},null,8,["initData"])],512)),[[h,H.value]]):u("",!0),o.value.length>0?n((t(),a("div",O,[s("img",{id:"imgbg",src:o.value[0].base64,onLoad:I},null,40,F),i[3]||(i[3]=s("canvas",{id:"canvas1"},null,-1)),i[4]||(i[4]=s("canvas",{id:"canvas2"},null,-1))],512)),[[h,H.value]]):u("",!0),S.value.length>0?(t(),r(w,{key:2,images:S.value},null,8,["images"])):u("",!0),d(g,{dataObj:l.value,onHistory:P,onUse:V,onUpdata:W},null,8,["dataObj"])],64))}},[["__scopeId","data-v-5853fce3"]]);export{k as default};
