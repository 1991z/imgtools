import{_ as e,o as t,c as a,b as l,d as s,e as n,v as o,r as i,a as c,w as h,h as d,f as r,g as u,F as g}from"./index-7793aea8.js";import{S as m}from"./SelectImage-2100df7f.js";import{S as f,D as v}from"./DownloadImage-2e5a1afd.js";const p={class:"max-box"},b=["src"],y={class:"min-box"},x={class:"min-box"},w={class:"min-box"};const I=e({props:{initData:{type:Object}},data:()=>({base64:null,sel:1,offsetX:0,offsetY:0,locs:[],width:0,height:0}),mounted(){Object.assign(this.$data,this.$props.initData)},methods:{readFIle(e){let t=e.target.files;for(let a=0;a<t.length;a++){let e=new FileReader;e.readAsDataURL(t[a]),e.onload=e=>{this.$data.base64=e.target.result}}},loadImg(e){let t=e.target.naturalWidth,a=e.target.naturalHeight;this.$data.width=t,this.$data.height=a;let{base64:l,sel:s,offsetX:n,offsetY:o,locs:i}=this.$data;this.$emit("c-data",{base64:l,sel:s,offsetX:n,offsetY:o,locs:i,width:t,height:a})}},watch:{sel:{handler(){this.$emit("c-data",{sel:this.sel})}},offsetX:{handler(){this.$emit("c-data",{offsetX:this.offsetX})}},offsetY:{handler(){this.$emit("c-data",{offsetY:this.offsetY})}}}},[["render",function(e,i,c,h,d,r){return t(),a("div",p,[l("img",{src:d.base64,alt:"参考图片",onLoad:i[0]||(i[0]=(...e)=>r.loadImg&&r.loadImg(...e))},null,40,b),l("div",y,[l("input",{type:"file",accept:"image/jpeg,image/jpg,image/png",onChange:i[1]||(i[1]=(...e)=>r.readFIle&&r.readFIle(...e))},null,32),l("button",{onClick:i[2]||(i[2]=t=>e.$emit("c-test"))},"测试")]),l("div",x,[i[6]||(i[6]=s(" 第N个")),n(l("input",{type:"number","onUpdate:modelValue":i[3]||(i[3]=e=>d.sel=e)},null,512),[[o,d.sel]])]),l("div",w,[n(l("input",{type:"number","onUpdate:modelValue":i[4]||(i[4]=e=>d.offsetX=e),placeholder:"dx"},null,512),[[o,d.offsetX]]),n(l("input",{type:"number","onUpdate:modelValue":i[5]||(i[5]=e=>d.offsetY=e),placeholder:"dy"},null,512),[[o,d.offsetY]])])])}],["__scopeId","data-v-86c5337b"]]),C=e=>{let t={},a=97;for(let s=0;s<e.length;s++){let l=!0;for(let a in t)if(t[a].some((t=>{return a=e[s],l=t,Math.abs(a.x-l.x)<2&&Math.abs(a.y-l.y)<2;var a,l}))){t[a].push(e[s]),l=!1;break}l&&(t[String.fromCharCode(a)]=[e[s]],a++)}let l=[];for(let s in t){let e=0,a=0;for(let l=0;l<t[s].length;l++)e+=t[s][l].x,a+=t[s][l].y;e=Math.floor(e/t[s].length),a=Math.floor(a/t[s].length),l.push({x:e,y:a})}return l},M=(e,t)=>{const a=[],l=e.data32F;for(let d=0;d<l.length;d++)if(l[d]>.8){const t=Math.floor(d/e.cols),l=d%e.cols;a.push({x:l,y:t})}let s=C(a),{sel:n,offsetX:o,offsetY:i}=t;n<0?(s=s.slice().reverse(),n=-n):0==n&&(n=1),n>s.length&&(n=s.length);let{x:c,y:h}=s[n-1];return{x:c+o,y:h+i}},D={key:0},E={key:0},_={key:1,class:"doBox"},F=["src"],k=e({__name:"imageCropDynamic",setup(e){const s=i([]);function o(e){s.value.push(e)}function p(e){for(let t=0;t<s.value.length;t++)if(s.value[t].timeStamp==e.k){s.value[t].width=e.w,s.value[t].height=e.h;break}}function b(e){let t=e.target.naturalWidth,a=e.target.naturalHeight;const l=document.getElementById("imgbg"),s=document.getElementById("canvas1"),n=document.getElementById("canvas2");s.style.width=l.width+"px",s.style.height=l.height+"px",n.style.width=l.width+"px",n.style.height=l.height+"px",s.width=t,s.height=a,n.width=t,n.height=a}function y(e){let t,a,l;if(e){if(0==T.value.locs.length)return;a=document.getElementById("canvas2"),t=T.value,l="rgba(0, 255, 0, 1)"}else{if(0==w.value.locs.length)return;a=document.getElementById("canvas1"),t=w.value,l="rgba(255, 0, 0, 1)"}let s=(e=>{let{sel:t,offsetX:a,offsetY:l,locs:s}=e;t<0?(s=s.slice().reverse(),t=-t):0==t&&(t=1),t>s.length&&(t=s.length);let{x:n,y:o}=s[t-1];return{x:n+a,y:o+l}})(t);const n=a.getContext("2d");n.clearRect(0,0,a.width,a.height),n.beginPath(),n.strokeStyle=l,t.locs.forEach((e=>{n.rect(e.x,e.y,t.width,t.height)})),n.moveTo(s.x,0),n.lineTo(s.x,a.height),n.moveTo(0,s.y),n.lineTo(a.width,s.y),n.stroke()}function x(e){let t=e?T.value:w.value;var a,l;(a=s.value[0],l=t,new Promise(((e,t)=>{const s=new Image;s.onload=()=>{const a=new Image;a.onload=()=>{const l=cv.imread(s),n=cv.imread(a),o=new cv.Mat;try{cv.matchTemplate(l,n,o,cv.TM_CCOEFF_NORMED)}catch(h){return void t("no match")}const i=[],c=o.data32F;for(let e=0;e<c.length;e++)if(c[e]>.8){const t=Math.floor(e/o.cols),a=e%o.cols;i.push({x:a,y:t})}l.delete(),n.delete(),e(C(i))},a.src=l.base64},s.src=a.base64}))).then((t=>(t=>{e?T.value.locs=t:w.value.locs=t,y(e)})(t))).catch((e=>{}))}const w=i({locs:[]});function k(e){w.value=Object.assign(w.value,e),y(0)}const T=i({locs:[]});function $(e){T.value=Object.assign(T.value,e),y(1)}const j=i([]);function O(){s.value.forEach(((e,t)=>{((e,t,a,l,s)=>new Promise(((n,o)=>{if(void 0===e.base64)return void o("image no base64");if(void 0===t.base64)return void o("match1 no base64");if(void 0===a.base64)return void o("match2 no base64");if(l<0||l>.97)return void o("quality must be between 0 and 0.97");const i=new Image;i.onload=()=>{const e=new Image;e.onload=()=>{const c=new Image;c.onload=()=>{const h=cv.imread(i),d=cv.imread(e),r=cv.imread(c),u=new cv.Mat,g=new cv.Mat;try{cv.matchTemplate(h,d,u,cv.TM_CCOEFF_NORMED),cv.matchTemplate(h,r,g,cv.TM_CCOEFF_NORMED)}catch(E){return void o("no match")}const m=M(u,t),f=M(g,a);let v,p,b,y;if(h.delete(),d.delete(),r.delete(),m.x<f.x?(v=m.x,b=f.x-m.x):(v=f.x,b=m.x-f.x),m.y<f.y?(p=m.y,y=f.y-m.y):(p=f.y,y=m.y-f.y),b<10||y<10)return void o("width or height too small");v<0&&(v=0),p<0&&(p=0),b>i.width&&(b=i.width),y>i.height&&(y=i.height),v+b>i.width&&(v=i.width-b),p+y>i.height&&(p=i.height-y);const x=document.createElement("canvas");x.width=b,x.height=y,x.getContext("2d").drawImage(i,v,p,b,y,0,0,b,y);const w="image/jpeg",I=x.toDataURL(w,l);let C=I.length-`data:${w};base64,`.length;C=parseInt(C-C/4);const D=Date.parse(new Date)/100+s;n({size:C,type:w,timeStamp:D,base64:I})},c.src=a.base64},e.src=t.base64},i.src=e.base64})))(e,w.value,T.value,.3,t).then((e=>{j.value.push(e)})).catch((e=>{}))}))}const X=i(!0);return(e,i)=>(t(),a(g,null,[c(m,{multiple:"",onGetImage:o},{default:h((()=>[s.value.length>0?(t(),a("div",D,[l("button",{onClick:i[0]||(i[0]=e=>X.value=!X.value)},"设置参考"),l("button",{onClick:O,style:{"margin-left":"2px"}},"裁剪")])):r("",!0)])),_:1}),c(f,{images:s.value,name:"imagesBox1",onGetWH:p},null,8,["images"]),s.value.length>0?n((t(),a("div",E,[c(I,{onCTest:i[1]||(i[1]=e=>x(0)),onCData:k}),c(I,{onCTest:i[2]||(i[2]=e=>x(1)),onCData:$})],512)),[[d,X.value]]):r("",!0),s.value.length>0?n((t(),a("div",_,[l("img",{id:"imgbg",src:s.value[0].base64,onLoad:b},null,40,F),i[3]||(i[3]=l("canvas",{id:"canvas1"},null,-1)),i[4]||(i[4]=l("canvas",{id:"canvas2"},null,-1))],512)),[[d,X.value]]):r("",!0),j.value.length>0?(t(),u(v,{key:2,images:j.value},null,8,["images"])):r("",!0)],64))}},[["__scopeId","data-v-3f1ef29b"]]);export{k as default};
